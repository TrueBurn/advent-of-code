<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advent of Code Leaderboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0d1117;
            --card: #161b22;
            --card-alt: #1c2128;
            --border: #30363d;
            --text: #e6edf3;
            --text-muted: #7d8590;
            --gold: #f0c14b;
            --silver: #8b949e;
            --bronze: #da7b3a;
            --p1: #58a6ff;
            --p2: #3fb950;
            --accent: #a371f7;
            --fast: #3fb950;
            --medium: #d29922;
            --slow: #f85149;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.4;
            padding: 20px;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        h1 { font-size: 24px; font-weight: 600; }
        h1 span { color: var(--gold); }

        .event-badge {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
        }

        /* Upload */
        .upload {
            background: var(--card);
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 28px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .upload:hover { border-color: var(--p1); }
        .upload.compact { padding: 8px 14px; display: inline-block; margin-bottom: 14px; font-size: 12px; }
        .upload input { display: none; }
        .upload-text { color: var(--text-muted); }
        .file-name { color: var(--p2); font-weight: 600; margin-left: 8px; }

        .hidden { display: none !important; }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--text-muted);
            align-items: center;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 2px; }

        /* Table */
        .board {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .board-header {
            display: grid;
            grid-template-columns: 50px 140px repeat(var(--num-days), 1fr);
            background: var(--card-alt);
            padding: 10px 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border);
        }

        .board-header > div { text-align: center; }
        .board-header > div:nth-child(1) { text-align: center; }
        .board-header > div:nth-child(2) { text-align: left; }

        .member-row {
            display: grid;
            grid-template-columns: 50px 140px repeat(var(--num-days), 1fr);
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .member-row:last-child { border-bottom: none; }
        .member-row:hover { background: var(--card-alt); }

        .rank {
            font-weight: 700;
            font-size: 15px;
            text-align: center;
        }
        .rank-1 { color: var(--gold); }
        .rank-2 { color: var(--silver); }
        .rank-3 { color: var(--bronze); }

        .member-info { padding-right: 12px; }
        .member-name {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .member-stats {
            font-size: 11px;
            color: var(--text-muted);
        }
        .member-stats .stars { color: var(--gold); }
        .member-stats .score { color: var(--accent); }

        /* Day Cell */
        .day-cell {
            padding: 4px 6px;
        }

        .day-cell.empty {
            color: var(--text-muted);
            font-size: 18px;
            text-align: center;
            opacity: 0.3;
        }

        .time-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 3px;
        }
        .time-row:last-child { margin-bottom: 0; }

        .time-label {
            font-size: 9px;
            font-weight: 700;
            width: 18px;
            flex-shrink: 0;
        }
        .time-label.p1 { color: var(--p1); }
        .time-label.p2 { color: var(--p2); }

        .time-bar-container {
            flex: 1;
            height: 18px;
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .time-bar {
            height: 100%;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            font-size: 10px;
            font-weight: 600;
            color: #fff;
            min-width: fit-content;
            padding-left: 6px;
        }

        .time-bar.p1 { background: var(--p1); }
        .time-bar.p2 { background: var(--p2); }

        /* Speed-based opacity */
        .time-bar.speed-1 { opacity: 1; }
        .time-bar.speed-2 { opacity: 0.85; }
        .time-bar.speed-3 { opacity: 0.7; }
        .time-bar.speed-4 { opacity: 0.55; }

        /* Summary */
        .summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .summary-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
        }

        .summary-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 22px;
            font-weight: 700;
        }

        .summary-detail {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Print - Keep dark mode */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: var(--bg) !important;
                padding: 10px;
            }

            .upload { display: none !important; }
            .container { max-width: none; }

            header { margin-bottom: 12px; padding-bottom: 10px; }
            h1 { font-size: 18px; }

            .legend { margin-bottom: 10px; font-size: 10px; }

            .board-header { padding: 6px 8px; font-size: 9px; }

            .member-row {
                padding: 6px 8px;
                page-break-inside: avoid;
                break-inside: avoid;
            }

            .rank { font-size: 12px; }
            .member-name { font-size: 11px; }
            .member-stats { font-size: 9px; }

            .day-cell { padding: 2px 4px; }
            .time-row { gap: 4px; margin-bottom: 2px; }
            .time-label { font-size: 8px; width: 14px; }
            .time-bar-container { height: 14px; }
            .time-bar { font-size: 8px; padding-right: 4px; padding-left: 4px; }

            .summary { margin-top: 12px; gap: 8px; }
            .summary-card { padding: 10px; }
            .summary-label { font-size: 8px; }
            .summary-value { font-size: 16px; }
            .summary-detail { font-size: 9px; }
        }

        @page { margin: 0.5cm; size: landscape; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Advent of <span>Code</span></h1>
            <div id="eventBadge" class="event-badge"></div>
        </header>

        <div id="upload" class="upload">
            <input type="file" id="fileInput" accept=".json">
            <span class="upload-text">Drop JSON or click to upload</span>
            <span id="fileName" class="file-name"></span>
        </div>

        <div id="content" class="hidden">
            <div class="legend">
                <span>Legend:</span>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--p1)"></div>
                    <span>P1 (from unlock)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: var(--p2)"></div>
                    <span>P2 (from P1)</span>
                </div>
                <span style="margin-left: auto; opacity: 0.7;">Bar width = relative time (wider = slower)</span>
            </div>

            <div class="board">
                <div id="boardHeader" class="board-header"></div>
                <div id="boardBody"></div>
            </div>

            <div id="summary" class="summary"></div>
        </div>
    </div>

    <script>
        const upload = document.getElementById('upload');
        const fileInput = document.getElementById('fileInput');
        const fileNameEl = document.getElementById('fileName');
        const content = document.getElementById('content');

        upload.addEventListener('click', () => fileInput.click());
        upload.addEventListener('dragover', e => e.preventDefault());
        upload.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

        function handleFile(file) {
            fileNameEl.textContent = file.name;
            upload.classList.add('compact');
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    render(JSON.parse(e.target.result));
                    content.classList.remove('hidden');
                } catch (err) { alert('Invalid JSON'); }
            };
            reader.readAsText(file);
        }

        function render(data) {
            let year = data.event ? parseInt(data.event) : 2024;
            if (!data.event && data.day1_ts) year = new Date(data.day1_ts * 1000).getUTCFullYear();

            const maxDays = year >= 2025 ? 12 : 25;
            let actualMaxDay = 0;
            Object.values(data.members).forEach(m => {
                Object.keys(m.completion_day_level || {}).forEach(d => {
                    actualMaxDay = Math.max(actualMaxDay, parseInt(d));
                });
            });
            const numDays = Math.min(maxDays, Math.max(actualMaxDay, 1));

            // Set CSS variable for grid
            document.documentElement.style.setProperty('--num-days', numDays);

            document.getElementById('eventBadge').textContent = `${year} · Days 1–${numDays}`;

            const members = Object.values(data.members)
                .filter(m => m.stars > 0)
                .sort((a, b) => b.local_score - a.local_score);

            // Calculate time stats for scaling (use log scale thresholds)
            // Thresholds: <5m = 20%, <15m = 40%, <1h = 60%, <3h = 80%, >3h = 100%
            const timeToPercent = (sec) => {
                if (sec <= 0) return 5;
                if (sec < 5 * 60) return 15 + (sec / (5 * 60)) * 20;        // 0-5m: 15-35%
                if (sec < 15 * 60) return 35 + ((sec - 5*60) / (10*60)) * 20;  // 5-15m: 35-55%
                if (sec < 60 * 60) return 55 + ((sec - 15*60) / (45*60)) * 20; // 15m-1h: 55-75%
                if (sec < 3 * 60 * 60) return 75 + ((sec - 60*60) / (2*60*60)) * 15; // 1-3h: 75-90%
                return 90 + Math.min(10, (sec - 3*60*60) / (21*60*60) * 10);  // >3h: 90-100%
            };

            // Build header
            const headerEl = document.getElementById('boardHeader');
            let headerHTML = '<div>#</div><div>Name</div>';
            for (let d = 1; d <= numDays; d++) {
                headerHTML += `<div>Day ${d}</div>`;
            }
            headerEl.innerHTML = headerHTML;

            // Build rows
            const body = document.getElementById('boardBody');
            body.innerHTML = '';

            members.forEach((member, idx) => {
                const rank = idx + 1;
                const completion = member.completion_day_level || {};

                const row = document.createElement('div');
                row.className = 'member-row';

                let html = `
                    <div class="rank ${rank <= 3 ? 'rank-' + rank : ''}">${rank}</div>
                    <div class="member-info">
                        <div class="member-name">${member.name || 'Anonymous'}</div>
                        <div class="member-stats">
                            <span class="stars">★${member.stars}</span>
                            <span class="score">${member.local_score}pts</span>
                        </div>
                    </div>
                `;

                for (let d = 1; d <= numDays; d++) {
                    const dayData = completion[d];
                    const dayStart = getDayStart(year, d);

                    if (dayData && dayData['1']) {
                        const t1 = dayData['1'].get_star_ts - dayStart;
                        const t2 = dayData['2'] ? dayData['2'].get_star_ts - dayData['1'].get_star_ts : 0;

                        const w1 = timeToPercent(t1);
                        const w2 = timeToPercent(t2);

                        const speed1 = getSpeedClass(t1);
                        const speed2 = getSpeedClass(t2);

                        html += `<div class="day-cell">`;

                        // P1 bar
                        html += `<div class="time-row">
                            <span class="time-label p1">P1</span>
                            <div class="time-bar-container">
                                <div class="time-bar p1 speed-${speed1}" style="width:${w1}%">${fmtTime(t1)}</div>
                            </div>
                        </div>`;

                        // P2 bar
                        if (dayData['2']) {
                            html += `<div class="time-row">
                                <span class="time-label p2">P2</span>
                                <div class="time-bar-container">
                                    <div class="time-bar p2 speed-${speed2}" style="width:${w2}%">${fmtTime(t2)}</div>
                                </div>
                            </div>`;
                        } else {
                            html += `<div class="time-row">
                                <span class="time-label p2">P2</span>
                                <div class="time-bar-container">
                                    <div class="time-bar p2" style="width:0%;opacity:0.3">—</div>
                                </div>
                            </div>`;
                        }

                        html += `</div>`;
                    } else {
                        html += `<div class="day-cell empty">—</div>`;
                    }
                }

                row.innerHTML = html;
                body.appendChild(row);
            });

            renderSummary(members, year, numDays);
        }

        function getDayStart(year, day) {
            return Date.UTC(year, 11, day, 5, 0, 0) / 1000;
        }

        function getSpeedClass(sec) {
            if (sec < 10 * 60) return 1;      // < 10 min
            if (sec < 30 * 60) return 2;      // < 30 min
            if (sec < 2 * 60 * 60) return 3;  // < 2 hours
            return 4;                          // > 2 hours
        }

        function fmtTime(sec) {
            if (sec < 60) return `${Math.floor(sec)}s`;
            if (sec < 3600) {
                const m = Math.floor(sec / 60);
                const s = Math.floor(sec % 60);
                return s > 0 && m < 10 ? `${m}m${s}s` : `${m}m`;
            }
            if (sec < 86400) {
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                return m > 0 ? `${h}h${m}m` : `${h}h`;
            }
            const d = Math.floor(sec / 86400);
            const h = Math.floor((sec % 86400) / 3600);
            return h > 0 ? `${d}d${h}h` : `${d}d`;
        }

        function renderSummary(members, year, numDays) {
            const section = document.getElementById('summary');

            const totalStars = members.reduce((s, m) => s + m.stars, 0);
            const maxStars = members.length * numDays * 2;
            const pct = maxStars > 0 ? Math.round((totalStars / maxStars) * 100) : 0;

            let fastP1 = { t: Infinity, n: '', d: 0 };
            let fastP2 = { t: Infinity, n: '', d: 0 };

            members.forEach(m => {
                Object.entries(m.completion_day_level || {}).forEach(([d, p]) => {
                    const ds = getDayStart(year, parseInt(d));
                    if (p['1']) {
                        const t1 = p['1'].get_star_ts - ds;
                        if (t1 < fastP1.t) fastP1 = { t: t1, n: m.name || 'Anon', d };
                    }
                    if (p['2'] && p['1']) {
                        const t2 = p['2'].get_star_ts - p['1'].get_star_ts;
                        if (t2 < fastP2.t) fastP2 = { t: t2, n: m.name || 'Anon', d };
                    }
                });
            });

            section.innerHTML = `
                <div class="summary-card">
                    <div class="summary-label">Participants</div>
                    <div class="summary-value">${members.length}</div>
                    <div class="summary-detail">with stars</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Stars</div>
                    <div class="summary-value" style="color:var(--gold)">★ ${totalStars}</div>
                    <div class="summary-detail">${pct}% complete</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Fastest P1</div>
                    <div class="summary-value" style="color:var(--p1)">${fmtTime(fastP1.t)}</div>
                    <div class="summary-detail">${fastP1.n} · Day ${fastP1.d}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Fastest P2</div>
                    <div class="summary-value" style="color:var(--p2)">${fmtTime(fastP2.t)}</div>
                    <div class="summary-detail">${fastP2.n} · Day ${fastP2.d}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
